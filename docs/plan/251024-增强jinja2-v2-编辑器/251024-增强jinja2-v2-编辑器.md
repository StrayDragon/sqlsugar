# 增强 Jinja2 V2 编辑器需求文档

> **文档版本**: v1.0
> **创建日期**: 2025年10月24日
> **最后更新**: 2025年10月24日
> **状态**: 待评审

---

## 📋 文档目录

1. [产品概述](#产品概述)
2. [功能现状分析](#功能现状分析)
3. [问题识别](#问题识别)
4. [需求规划](#需求规划)
5. [实施路线图](#实施路线图)
6. [验收标准](#验收标准)
7. [附录](#附录)

---

## 一、产品概述

### 1.1 产品定位

SQLSugar Jinja2 编辑器 V2 是一个**专为 SQL 模板设计的可视化编辑工具**，基于 Nunjucks 模板引擎（Jinja2 兼容），提供直观的变量编辑界面和实时 SQL 预览能力。

**核心价值**：
- ✅ **所见即所得**：直接点击模板中的变量进行内联编辑
- ✅ **实时反馈**：编辑时即时查看渲染后的 SQL 语句
- ✅ **类型安全**：智能类型推断和验证，防止输入错误
- ✅ **SQL 安全**：专用过滤器（sql_quote, sql_in 等）防止注入攻击

### 1.2 适用场景

**非常适合** (85%+ 支持度)：
- 动态 SQL 查询构建
- 条件过滤和查询
- 列表和循环处理
- 简单到中等复杂度的模板

**基本适合** (60-85% 支持度)：
- 使用宏的复杂模板
- 需要高级测试的场景

**不太适合** (<60% 支持度)：
- 大量使用 `{% set %}` 的模板
- 需要模板继承的场景
- 需要过滤器块的场景

### 1.3 当前状态

- **总体支持度**: 71.5%
- **完全支持**: 1/10 测试 (100%)
- **部分支持**: 5/10 测试 (60-95%)
- **有限支持**: 4/10 测试 (<60%)
- **推荐指数**: ⭐⭐⭐⭐☆ (4/5)

### 1.4 改进目标

**短期目标**（1-2周）：
- 将功能覆盖率从 **71.5%** 提升至 **85%+**
- 完善宏和 set 变量的 UI 支持
- 添加缺失的测试函数

**长期愿景**：
- 成为业界领先的 SQL 模板可视化编辑器
- 支持 90%+ 的常见 Jinja2/SQL 模板场景
- 提供完整的开发者工具链（调试、性能分析、协作）

---

## 二、功能现状分析

### 2.1 功能支持矩阵

| 功能类别 | 支持状态 | 覆盖率 | 说明 |
|---------|---------|-------|------|
| 基础变量和类型 | ✅ 完全支持 | 100% | 简单变量、嵌套变量、类型推断 |
| 条件和循环 | ✅ 完全支持 | 100% | if/elif/else、for/endfor、loop 变量 |
| 基础过滤器 | ✅ 完全支持 | 100% | 40+ 个过滤器（字符串、数字、列表） |
| SQL 专用功能 | ✅ 完全支持 | 100% | sql_quote、sql_in、sql_identifier 等 |
| 宏定义 | ⚠️ 部分支持 | 60% | 语法支持，但 UI 编辑有限 |
| 变量赋值 ({% set %}) | ⚠️ 部分支持 | 50% | 语法支持，但不提取到 UI |
| 高级测试 | ⚠️ 部分支持 | 70% | 缺失 divisibleby、is_number、sameas |
| 模板继承 | ❌ 不支持 | 0% | 单文件编辑器设计限制 |
| 模板包含 | ❌ 不支持 | 0% | 单文件编辑器设计限制 |
| 过滤器块 | ❌ 不支持 | 30% | Nunjucks 支持有限 |

### 2.2 测试结果统计

| 测试编号 | 测试名称 | 支持度 | 状态 | 主要问题 |
|---------|---------|-------|------|---------|
| 01 | 基础变量和简单条件 | 100% | ✅ | 无 |
| 02 | 过滤器和测试表达式 | 85% | ⚠️ | 缺失 divisibleby 测试 |
| 03 | 复杂循环和条件 | 95% | ⚠️ | 字典迭代需要正确结构 |
| 04 | 宏定义和使用 | 60% | ⚠️ | 宏 UI 支持不足 |
| 05 | 复杂过滤器组合 | 90% | ⚠️ | 动态 SQL 安全警告 |
| 06 | 高级测试表达式 | 70% | ⚠️ | 缺失多个测试函数 |
| 07 | 变量赋值和操作 | 50% | ❌ | set 变量不提取 |
| 08 | 复杂宏 | 60% | ⚠️ | 宏 UI 支持不足 |
| 09 | 过滤器块 | 30% | ❌ | Nunjucks 限制 |
| 10 | 综合示例 | 75% | ⚠️ | 综合前述问题 |

**平均支持度**: 71.5%

### 2.3 已实现的核心功能

#### 2.3.1 变量和类型系统
- ✅ 简单变量替换 (`{{ variable }}`)
- ✅ 嵌套变量访问 (`{{ user.id }}`, `{{ user.name }}`)
- ✅ 智能类型推断（基于变量名）
- ✅ 11 种数据类型：`string`, `number`, `integer`, `boolean`, `date`, `time`, `datetime`, `json`, `uuid`, `email`, `url`, `null`
- ✅ 类型转换和验证

#### 2.3.2 过滤器 (40+)

**字符串过滤器**:
- `upper`, `lower`, `title`, `capitalize`, `trim`, `replace`, `truncate`, `wordwrap`, `urlencode`, `striptags`

**数字过滤器**:
- `int`, `float`, `abs`, `round`, `sum`, `min`, `max`

**列表/数组过滤器**:
- `length`, `join`, `first`, `last`, `unique`, `reverse`, `slice`, `sort`

**SQL 专用过滤器**:
- `sql_quote` - SQL 字符串转义
- `sql_identifier` - SQL 标识符转义
- `sql_date`, `sql_datetime` - 日期格式化
- `sql_in` - 生成 IN 子句值列表

**其他过滤器**:
- `default`, `bool`, `string`, `dictsort`, `tojson`, `filesizeformat`, `equalto`

#### 2.3.3 控制结构
- ✅ 条件语句：`{% if %}...{% elif %}...{% else %}...{% endif %}`
- ✅ 循环语句：`{% for item in items %}...{% endfor %}`
- ✅ 循环变量：`loop.first`, `loop.last`, `loop.index`
- ✅ 循环过滤：`{% for item in items if condition %}`
- ✅ 空列表处理：`{% else %}` 子句
- ✅ 注释：`{# comment #}`

#### 2.3.4 UI 功能
- ✅ 直接模板交互（点击高亮变量进行内联编辑）
- ✅ 智能弹出框（上下文感知的变量编辑器）
- ✅ 实时预览（编辑时即时查看 SQL 渲染结果）
- ✅ 语法高亮（SQL 和模板语法）
- ✅ 键盘导航（Tab/Shift+Tab、Enter、Escape、Ctrl+S 等）
- ✅ 响应式布局（宽/窄屏适配）
- ✅ 主题支持（深色/浅色/高对比度）
- ✅ 动画效果（可配置）
- ✅ 变量值建议
- ✅ 历史记录追踪

#### 2.3.5 SQLAlchemy 支持
- ✅ 混合占位符（`:param` + `{{ jinja2 }}`）
- ✅ 占位符类型检测
- ✅ 自动转换为 SQL 字面量

---

## 三、问题识别

### 3.1 核心问题（P0 级别）

#### 3.1.1 {% set %} 变量不提取到 UI

**问题描述**：
```jinja2
{% set page_size = 20 %}
{% set offset = (page - 1) * page_size %}

SELECT * FROM users
LIMIT {{ page_size }}
OFFSET {{ offset }}
```

使用 `{% set %}` 定义的变量 `page_size` 和 `offset` 不会出现在编辑器的变量列表中，用户无法通过 UI 修改这些变量的值。

**影响范围**：
- 测试 07 (变量赋值和操作) 支持度仅 50%
- 测试 10 (综合示例) 受此影响降至 75%

**用户痛点**：
- 必须手动修改模板代码，无法享受可视化编辑的便利
- 对于复杂的变量计算，用户体验大幅下降

**技术原因**：
- 变量提取逻辑 (`processor.ts`) 只识别 `{{ variable }}` 形式
- `{% set %}` 是 Nunjucks 语句，不在变量提取范围内

#### 3.1.2 宏参数 UI 支持不足

**问题描述**：
```jinja2
{% macro where_clause(field, operator, value) -%}
    AND {{ field }} {{ operator }} '{{ value }}'
{%- endmacro %}

SELECT * FROM users
WHERE 1=1
  {{ where_clause('username', '=', username_value) }}
```

- ✅ 宏调用时的参数（如 `username_value`）可以正常编辑
- ❌ 宏定义本身在 UI 中没有特殊标识
- ❌ 宏内部的变量（如 `field`, `operator`, `value`）不会出现在变量列表

**影响范围**：
- 测试 04 (宏定义和使用) 支持度仅 60%
- 测试 08 (复杂宏) 支持度仅 60%

**用户痛点**：
- 宏的存在对用户不透明
- 无法快速理解宏的参数和用途
- 宏定义部分被视为"静态代码"

#### 3.1.3 缺失高级测试函数

**问题描述**：

以下 Jinja2 测试在 Nunjucks 中不存在，导致模板渲染失败或行为不符合预期：

```jinja2
{% if quantity is divisibleby 10 %}  {# ❌ 不支持 #}
{% if age is number %}               {# ❌ 不支持 #}
{% if value is sameas other %}       {# ❌ 不支持 #}
```

**影响范围**：
- 测试 02 (过滤器和测试表达式) 降至 85%
- 测试 06 (高级测试表达式) 降至 70%

**用户痛点**：
- 从 Jinja2 迁移的模板无法直接使用
- 需要手动改写为其他形式的条件判断

**技术原因**：
- Nunjucks 的测试函数库不完整
- 需要在 `processor.ts` 中自定义添加

### 3.2 次要问题（P1 级别）

#### 3.2.1 缺乏模板片段库

**问题描述**：
- 用户需要反复编写常见的 SQL 模板模式（如分页、条件过滤、IN 子句等）
- 没有快速插入常用代码片段的功能

**用户痛点**：
- 重复劳动，降低开发效率
- 容易出错（如忘记使用 `sql_quote` 过滤器）

#### 3.2.2 错误提示不够友好

**问题描述**：
- 模板语法错误时，错误信息不够直观
- 缺少对变量未定义、类型不匹配等常见错误的提前警告
- 没有 SQL 注入风险检测

**用户痛点**：
- 调试困难，需要反复试错
- 安全隐患（如直接拼接用户输入）

#### 3.2.3 大型模板性能问题

**问题描述**：
- 当模板超过 500 行或包含大量变量（50+）时，编辑器可能出现卡顿
- 实时预览的渲染性能有待优化

**用户痛点**：
- 复杂项目中体验下降
- 需要等待较长时间才能看到渲染结果

### 3.3 设计限制（P2 级别）

#### 3.3.1 模板继承和包含

**问题描述**：
```jinja2
{% extends "base.sql" %}     {# ❌ 不支持 #}
{% block content %}...{% endblock %}
{% include "common.sql" %}   {# ❌ 不支持 #}
```

**原因**：
- 编辑器设计为单文件模式
- 支持多文件需要重大架构调整

**影响**：
- 测试 10 (综合示例) 部分降低
- 无法管理大型项目的模板库

#### 3.3.2 过滤器块支持有限

**问题描述**：
```jinja2
{% filter upper %}
select * from users
{% endfilter %}
```

**原因**：
- Nunjucks 对 `{% filter %}` 块的支持不如 Jinja2 完整
- SQL 上下文中使用场景较少

**影响**：
- 测试 09 (过滤器块) 支持度仅 30%
- 实际使用中影响较小（SQL 场景下不常用）

---

## 四、需求规划

### 4.1 高优先级需求（P0）

> **目标**：将功能覆盖率从 71.5% 提升至 85%+
> **时间**：1-2周

#### 需求 P0-1：支持 {% set %} 变量提取和编辑

**需求描述**：
1. 解析模板中的 `{% set variable = value %}` 语句
2. 将 set 变量提取到可编辑变量列表
3. 在 UI 中标注变量来源（set 定义 vs 模板变量）
4. 支持 set 变量的类型推断和验证

**实现要点**：
- 修改 `processor.ts` 中的变量提取逻辑
- 使用正则表达式或 AST 解析识别 `{% set %}` 语句
- 区分简单赋值 (`{% set x = 10 %}`) 和表达式赋值 (`{% set x = y * 2 %}`)
- 对于表达式赋值，允许编辑依赖的基础变量

**验收标准**：
- ✅ 测试 07 支持度从 50% 提升至 90%+
- ✅ 测试 10 支持度从 75% 提升至 85%+
- ✅ set 变量在 UI 中清晰显示，带有"Set Variable"标签
- ✅ 用户可以修改 set 变量的值，模板正确渲染

**技术方案示例**：
```typescript
// processor.ts
function extractSetVariables(template: string): Variable[] {
  const setRegex = /\{%\s*set\s+(\w+)\s*=\s*(.+?)\s*%\}/g;
  const variables: Variable[] = [];

  let match;
  while ((match = setRegex.exec(template)) !== null) {
    const [, name, value] = match;
    variables.push({
      name,
      value: evaluateExpression(value),
      type: inferType(value),
      source: 'set',
    });
  }

  return variables;
}
```

#### 需求 P0-2：改进宏的 UI 显示和体验

**需求描述**：
1. 在模板编辑器中高亮显示宏定义区域
2. 在变量列表中添加"宏"分类
3. 点击宏名称时，显示宏的文档（参数列表、用途说明）
4. 支持宏定义的折叠/展开

**实现要点**：
- 识别 `{% macro %}...{% endmacro %}` 块
- 解析宏的参数列表和默认值
- 在语法高亮器中添加宏的特殊样式
- 提供宏的悬停提示（tooltip）

**验收标准**：
- ✅ 测试 04 支持度从 60% 提升至 80%+
- ✅ 测试 08 支持度从 60% 提升至 80%+
- ✅ 宏定义区域在编辑器中有明显的视觉区分（如背景色）
- ✅ 变量列表中显示"宏"分类，列出所有宏及其参数
- ✅ 点击宏名称时弹出文档面板

**UI 设计示例**：
```
┌─ 变量列表 ─────────────────┐
│ 📁 模板变量 (5)            │
│   - user_id: 123           │
│   - status: 'active'       │
│                            │
│ 🔧 宏 (2)                  │
│   - where_clause(...)  ⓘ  │
│   - date_range(...)    ⓘ  │
│                            │
│ 📌 Set 变量 (3)            │
│   - page_size: 20          │
│   - offset: 0              │
└────────────────────────────┘
```

#### 需求 P0-3：添加缺失的测试函数

**需求描述**：
在 Nunjucks 环境中添加以下 Jinja2 兼容的测试函数：
1. `divisibleby(n)` - 检查是否能被 n 整除
2. `number` - 检查是否为数字类型
3. `sameas(other)` - 严格相等测试（===）

**实现要点**：
- 在 `processor.ts` 中使用 `env.addTest()` 添加自定义测试
- 确保与 Jinja2 行为一致
- 添加单元测试验证功能

**验收标准**：
- ✅ 测试 02 支持度从 85% 提升至 95%+
- ✅ 测试 06 支持度从 70% 提升至 90%+
- ✅ 以下模板可以正确渲染：
  ```jinja2
  {% if quantity is divisibleby 10 %}
  {% if age is number %}
  {% if value is sameas other %}
  ```

**技术方案示例**：
```typescript
// processor.ts
env.addTest('divisibleby', function(value: any, divisor: number) {
  return Number(value) % Number(divisor) === 0;
});

env.addTest('number', function(value: any) {
  return typeof value === 'number' || !isNaN(Number(value));
});

env.addTest('sameas', function(value: any, other: any) {
  return value === other;
});
```

### 4.2 中优先级需求（P1）

> **目标**：提升用户体验和开发效率
> **时间**：1-2个月

#### 需求 P1-1：模板片段库

**需求描述**：
1. 内置常用 SQL 模板片段（分页、IN 子句、日期范围、条件过滤等）
2. 支持用户自定义片段
3. 提供快速插入功能（快捷键 + 命令面板）
4. 片段支持占位符（插入后自动定位到可编辑位置）

**片段示例**：
```yaml
- name: "分页查询"
  prefix: "page"
  template: |
    LIMIT {{ limit | default(10) }}
    OFFSET {{ offset | default(0) }}

- name: "IN 子句"
  prefix: "in"
  template: |
    WHERE {{ field }} IN (
      {% for item in items %}
        {{ item | sql_quote }}{% if not loop.last %}, {% endif %}
      {% endfor %}
    )

- name: "日期范围"
  prefix: "daterange"
  template: |
    {% if start_date %}
    AND {{ field }} >= {{ start_date | sql_date }}
    {% endif %}
    {% if end_date %}
    AND {{ field }} <= {{ end_date | sql_date }}
    {% endif %}
```

**验收标准**：
- ✅ 至少提供 10 个内置片段
- ✅ 用户可以在设置中管理自定义片段
- ✅ 命令面板中可以搜索和插入片段
- ✅ 插入后光标自动定位到第一个变量

#### 需求 P1-2：增强的错误提示和验证

**需求描述**：
1. **语法错误定位**：在模板编辑器中标注错误位置（红色波浪线）
2. **变量未定义警告**：检测使用了但未定义的变量
3. **类型不匹配提示**：检测明显的类型错误（如字符串 + 数字）
4. **SQL 注入风险检测**：识别未使用 `sql_quote` 的动态字符串拼接
5. **悬停提示**：鼠标悬停在变量上时显示类型和值

**验收标准**：
- ✅ 语法错误在编辑器中实时显示，带有错误描述
- ✅ 未定义变量显示黄色警告波浪线
- ✅ SQL 注入风险显示红色警告图标，附带修复建议
- ✅ 悬停提示显示完整的变量信息

**SQL 注入检测示例**：
```jinja2
❌ 检测到风险：
WHERE name = '{{ user_input }}'

✅ 建议修复：
WHERE name = {{ user_input | sql_quote }}
```

#### 需求 P1-3：性能优化

**需求描述**：
1. **增量渲染**：只渲染发生变化的部分
2. **虚拟滚动**：大型模板使用虚拟滚动优化渲染
3. **防抖优化**：用户输入时延迟 300ms 后再渲染
4. **缓存机制**：缓存已渲染的模板片段
5. **Web Worker**：将渲染过程移至后台线程

**验收标准**：
- ✅ 1000 行模板的编辑无明显卡顿
- ✅ 100+ 个变量的模板可以流畅编辑
- ✅ 实时预览延迟 < 500ms

### 4.3 低优先级需求（P2）

> **目标**：探索长期发展方向
> **时间**：3-6个月

#### 需求 P2-1：多文件模板支持

**需求描述**：
1. 支持 `{% extends %}` 和 `{% block %}` 语法
2. 支持 `{% include %}` 语法
3. 提供模板文件浏览器
4. 跨文件的变量追踪和跳转

**技术挑战**：
- 需要文件系统支持（VSCode Workspace API）
- 模板依赖关系管理
- 实时预览需要解析多个文件

#### 需求 P2-2：模板调试工具

**需求描述**：
1. 变量值追踪（显示每个变量在不同位置的值）
2. 渲染步骤查看（逐步执行模板渲染）
3. 性能分析（识别渲染性能瓶颈）
4. 断点调试（在特定位置暂停渲染）

#### 需求 P2-3：协作功能

**需求描述**：
1. 模板分享（生成分享链接）
2. 团队模板库（云端存储和同步）
3. 版本控制集成（Git blame、历史记录）
4. 评论和标注（在模板中添加注释和讨论）

---

## 五、实施路线图

### 阶段一：核心功能完善（1-2周）

**目标**：完成 P0 级别需求，将支持度提升至 85%+

| 任务 | 负责模块 | 工作量 | 依赖 |
|-----|---------|-------|------|
| P0-1: 支持 {% set %} 变量提取 | `processor.ts` | 3 天 | - |
| P0-2: 改进宏的 UI 显示 | `jinja2-editor-v2.ts`, `ui/` | 4 天 | - |
| P0-3: 添加缺失的测试函数 | `processor.ts` | 2 天 | - |
| 单元测试和集成测试 | `test/` | 2 天 | P0-1, P0-2, P0-3 |
| 文档更新 | `docs/`, `README.md` | 1 天 | 所有任务 |

**里程碑**：
- ✅ 测试 07 支持度达到 90%+
- ✅ 测试 04、08 支持度达到 80%+
- ✅ 测试 02、06 支持度达到 90%+
- ✅ 总体支持度达到 85%+

### 阶段二：用户体验提升（1-2个月）

**目标**：完成 P1 级别需求，打磨用户体验

| 任务 | 负责模块 | 工作量 | 依赖 |
|-----|---------|-------|------|
| P1-1: 模板片段库 | `ui/components/` | 1 周 | - |
| P1-2: 错误提示和验证 | `processor.ts`, `ui/` | 2 周 | - |
| P1-3: 性能优化 | 全部模块 | 2 周 | - |
| 用户测试和反馈收集 | - | 1 周 | 所有任务 |
| Bug 修复和优化 | 全部模块 | 1 周 | 用户测试 |

**里程碑**：
- ✅ 提供 10+ 个实用模板片段
- ✅ 实时错误提示和 SQL 注入检测上线
- ✅ 大型模板（1000+ 行）编辑流畅

### 阶段三：高级功能探索（3-6个月）

**目标**：完成 P2 级别需求，探索创新方向

| 任务 | 工作量 | 优先级 |
|-----|-------|-------|
| P2-1: 多文件模板支持 | 3-4 周 | 高 |
| P2-2: 模板调试工具 | 2-3 周 | 中 |
| P2-3: 协作功能 | 4-6 周 | 低 |

**里程碑**：
- ✅ 支持模板继承和包含
- ✅ 提供完整的调试工具链
- ✅ 上线团队协作功能（可选）

---

## 六、验收标准

### 6.1 功能覆盖率

| 阶段 | 目标支持度 | 关键指标 |
|-----|----------|---------|
| 当前 | 71.5% | 基准线 |
| 阶段一完成后 | 85%+ | ✅ 测试 02, 04, 06, 07, 08 显著提升 |
| 阶段二完成后 | 90%+ | ✅ 用户体验评分 4.5/5+ |
| 阶段三完成后 | 95%+ | ✅ 支持企业级复杂场景 |

### 6.2 测试结果预期

| 测试编号 | 当前支持度 | 阶段一目标 | 阶段二目标 |
|---------|-----------|-----------|-----------|
| 01 | 100% | 100% | 100% |
| 02 | 85% | **95%** ↑ | 95% |
| 03 | 95% | 95% | 98% |
| 04 | 60% | **80%** ↑ | 85% |
| 05 | 90% | 90% | 95% |
| 06 | 70% | **90%** ↑ | 95% |
| 07 | 50% | **90%** ↑ | 95% |
| 08 | 60% | **80%** ↑ | 85% |
| 09 | 30% | 30% | 40% |
| 10 | 75% | **85%** ↑ | 90% |
| **平均** | **71.5%** | **85.5%** | **90.8%** |

### 6.3 用户体验指标

| 指标 | 当前 | 阶段一目标 | 阶段二目标 |
|-----|-----|-----------|-----------|
| 编辑流畅度 | 4/5 | 4/5 | 4.5/5 |
| 功能完整性 | 3.5/5 | 4.5/5 | 4.8/5 |
| 错误提示准确性 | 3/5 | 3.5/5 | 4.5/5 |
| 学习曲线 | 4/5 | 4.5/5 | 4.5/5 |
| 整体满意度 | 4/5 | 4.3/5 | 4.7/5 |

### 6.4 性能指标

| 指标 | 当前 | 目标 | 测试场景 |
|-----|-----|-----|---------|
| 小型模板首次渲染 | < 100ms | < 100ms | < 50 行，< 10 个变量 |
| 中型模板首次渲染 | < 300ms | < 200ms | 100-500 行，10-30 个变量 |
| 大型模板首次渲染 | < 1000ms | < 500ms | 500-1000 行，30-100 个变量 |
| 变量编辑后重渲染 | < 200ms | < 100ms | 任意模板，修改单个变量 |
| UI 交互响应时间 | < 50ms | < 50ms | 点击、键盘导航等 |

---

## 七、附录

### 7.1 相关文档

- [功能调研总结](./JINJA2_RESEARCH_SUMMARY.md)
- [功能支持分析报告](./jinja2-editor-feature-analysis.md)
- [测试总结报告](./jinja2-testing-summary.md)
- [自动生成的测试报告](../../examples/jinja2VisualEditor/test-report.md)
- [示例使用指南](../../examples/jinja2VisualEditor/README.md)
- [编辑器 UI README](../../src/features/jinja2/ui/README.md)

### 7.2 测试文件位置

```
examples/jinja2VisualEditor/
├── 01-jinja2-example.sql         # 基础功能 (100%)
├── 02-filters-and-tests.sql      # 过滤器 (85%)
├── 03-loops-and-conditionals.sql # 循环 (95%)
├── 04-macros-basic.sql           # 宏 (60%)
├── 05-complex-filters.sql        # 复杂过滤器 (90%)
├── 06-advanced-tests.sql         # 高级测试 (70%)
├── 07-set-and-variables.sql      # 变量赋值 (50%)
├── 08-complex-macros.sql         # 复杂宏 (60%)
├── 09-filter-blocks.sql          # 过滤器块 (30%)
├── 10-comprehensive-example.sql  # 综合示例 (75%)
├── test-runner.cjs               # 测试运行器
├── generate-test-report.cjs      # 报告生成器
└── README.md                     # 使用指南
```

### 7.3 关键代码模块

| 模块 | 路径 | 职责 |
|-----|------|------|
| 模板处理器 | `src/features/jinja2/processor.ts` | 变量提取、模板渲染 |
| 编辑器组件 | `src/features/jinja2/ui/components/jinja2-editor-v2.ts` | 主编辑器 UI |
| 变量弹出框 | `src/features/jinja2/ui/components/variable-popover.ts` | 变量编辑交互 |
| 语法高亮 | `src/features/jinja2/ui/components/template-highlighter.ts` | 模板高亮显示 |
| SQLAlchemy 支持 | `src/features/jinja2/sqlalchemy.ts` | 混合占位符处理 |

### 7.4 技术栈

- **模板引擎**: Nunjucks 3.x (Jinja2 兼容)
- **UI 框架**: Lit (Web Components)
- **语法高亮**: Highlight.js
- **构建工具**: esbuild
- **测试框架**: Vitest
- **VSCode API**: v1.60+

### 7.5 风险和缓解措施

| 风险 | 影响 | 概率 | 缓解措施 |
|-----|-----|-----|---------|
| {% set %} 变量提取逻辑复杂 | 高 | 中 | 分阶段实现：先支持简单赋值，再支持表达式 |
| 性能优化效果不达预期 | 中 | 中 | 引入性能测试，设置明确的基准线 |
| Nunjucks 限制难以突破 | 低 | 低 | 考虑切换到原生 Jinja2（Python）或 Jinja-JS |
| 用户需求变化 | 中 | 高 | 定期收集用户反馈，灵活调整优先级 |

### 7.6 开发者最佳实践建议

**给用户的建议**：
1. ✅ **优先使用简单变量**，避免 `{% set %}`（阶段一完成后可以放心使用）
2. ✅ **使用 SQL 专用过滤器**保证安全性（`sql_quote`, `sql_in` 等）
3. ✅ **善用默认值**简化模板（`{{ limit | default(10) }}`）
4. ✅ **宏适合定义可复用片段**，参数可以正常编辑
5. ⚠️ **避免使用过滤器块**（`{% filter %}`）
6. ⚠️ **避免动态表名和列名**（存在 SQL 注入风险）

**给开发者的建议**：
1. 修改 `processor.ts` 时务必添加单元测试
2. UI 组件变更需要进行可访问性测试（键盘导航、屏幕阅读器）
3. 性能优化前先建立基准测试
4. 新增过滤器和测试函数需要更新文档
5. 重大变更需要提供迁移指南

---

**文档结束**

如有疑问或建议，请联系 SQLSugar 开发团队或提交 Issue。

